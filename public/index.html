<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ë¡œë²Œ ê²Œì„ ì‚°ì—… ì¹´ë“œ ë‰´ìŠ¤ í”¼ë“œ (ì‚¬ì „ ìš”ì•½)</title>
    <meta name="description" content="AI ê¸°ë°˜ ê¸€ë¡œë²Œ ê²Œì„ ì‚°ì—… ë‰´ìŠ¤ ë¶„ì„ ì„œë¹„ìŠ¤">
    <meta name="keywords" content="ê²Œì„ë‰´ìŠ¤, AIë¶„ì„, ê²Œì„ì‚°ì—…, ë‰´ìŠ¤ìš”ì•½">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .news-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #2d3748;
            cursor: pointer;
        }
        .news-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        .news-title {
            font-weight: 900;
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .news-summary {
            display: -webkit-box;
            -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.6;
        }
        .filter-btn.active {
            background-color: #7B68EE;
            color: #FFFFFF;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(123, 104, 238, 0.5);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10 mt-4 md:mt-0">
            <h1 class="text-3xl md:text-4xl font-extrabold text-[#7B68EE] mb-2">
                ğŸ® ê¸€ë¡œë²Œ ê²Œì„ ì‚°ì—… ì¸ì‚¬ì´íŠ¸ ìŠ¤í¬ë©
            </h1>
            <p id="news-date-info" class="text-lg md:text-xl font-semibold text-gray-300 mb-2"></p> 
            <p id="header-subtitle" class="text-gray-400 text-md md:text-lg">ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë§¤ì²´ì—ì„œ ìˆ˜ì§‘í•œ ìµœì†Œ 15ê°œ, ìµœëŒ€ 30ê°œì˜ ê¸°ì‚¬ì…ë‹ˆë‹¤.</p>
        </header>

        <section id="api-key-section" class="bg-gray-800 p-5 rounded-xl shadow-xl mb-10 border hidden">
            <h2 class="text-xl font-bold text-red-400 mb-3">âš ï¸ API í‚¤ ì„¤ì • ì˜¤ë¥˜</h2>
            <div class="text-center">
                <p class="text-gray-400 mb-4">Netlify í™˜ê²½ë³€ìˆ˜ì— GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-500">ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ Netlify ëŒ€ì‹œë³´ë“œì—ì„œ í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
        </section>

        <main id="feed-view">
            <section id="filters" class="flex justify-center space-x-2 md:space-x-4 mb-10 overflow-x-auto pb-3 border-b border-gray-700">
                <button class="filter-btn active text-sm md:text-base bg-gray-700 text-gray-300 py-2 px-4 md:px-6 rounded-full hover:bg-gray-600" data-filter="all" aria-label="ì „ì²´ ë‰´ìŠ¤ ë³´ê¸°">
                    ì „ì²´ ë™í–¥
                </button>
                <button class="filter-btn text-sm md:text-base bg-gray-700 text-gray-300 py-2 px-4 md:px-6 rounded-full hover:bg-gray-600" data-filter="domestic" aria-label="êµ­ë‚´ ë‰´ìŠ¤ ë³´ê¸°">
                    êµ­ë‚´ ì†Œì‹ ğŸ‡°ğŸ‡·
                </button>
                <button class="filter-btn text-sm md:text-base bg-gray-700 text-gray-300 py-2 px-4 md:px-6 rounded-full hover:bg-gray-600" data-filter="overseas" aria-label="í•´ì™¸ ë‰´ìŠ¤ ë³´ê¸°">
                    í•´ì™¸ ì†Œì‹ ğŸŒ
                </button>
            </section>

            <section id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8 min-h-[400px]">
            </section>
        </main>

        <div id="detail-view" class="hidden">
            <button onclick="showFeedPage()" class="flex items-center text-indigo-400 hover:text-white mb-6 transition-colors" aria-label="ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
            
            <article class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl mb-10">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center border-b border-gray-700 pb-4 mb-6">
                    <div>
                        <div id="detail-region" class="text-xl font-bold mb-2"></div>
                        <span id="detail-category" class="inline-block rounded-lg px-3 py-1 text-sm font-semibold"></span>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-3">
                        <a id="detail-source-link" target="_blank" rel="noopener noreferrer" 
                           class="flex items-center text-sm font-medium text-gray-300 transition-colors bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 shadow-lg"
                           aria-label="ì›ë³¸ ê¸°ì‚¬ ë³´ê¸°">
                           <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            ì›ë³¸ ê¸°ì‚¬ ë³´ê¸°
                        </a>
                    </div>
                </div>

                <h2 id="detail-title" class="text-3xl md:text-4xl font-extrabold text-white mb-6 leading-tight"></h2>
                
                <div id="detail-content" class="min-h-[200px] flex flex-col justify-center">
                </div>
            </article>
        </div>

        <div id="toast-container" class="fixed bottom-0 inset-x-0 p-4 flex items-center justify-center pointer-events-none z-50"></div>

        <footer class="text-center mt-12 py-6 border-t border-gray-700">
            <p class="text-gray-500 text-xs md:text-sm">ì¶œì²˜: Gemini ë° Google Search ì‹¤ì‹œê°„ ë¶„ì„ (<span id="footer-date-info"></span> ë‰´ìŠ¤ ê¸°ì¤€).</p>
        </footer>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        const NEWS_FEED_STORAGE_KEY = 'geminiNewsFeed';
        const CACHE_TIME_KEY = 'newsCacheTime';
        let apiKeyAvailable = false;

        // ìƒíƒœ ê´€ë¦¬
        let currentNewsItem = null; 
        let currentNewsFeed = []; 

        // UI ìš”ì†Œ
        const newsGrid = document.getElementById('news-grid');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const toastContainer = document.getElementById('toast-container');
        const detailView = document.getElementById('detail-view');
        const feedView = document.getElementById('feed-view');
        const apiKeySection = document.getElementById('api-key-section');
        
        // --- Netlify Functions API í˜¸ì¶œ í•¨ìˆ˜ ---
        async function callGeminiAPI(payload) {
            try {
                const response = await fetch('/api/gemini-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                return await response.json();
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // --- API í‚¤ ìƒíƒœ í™•ì¸ ---
        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/api/config-status');
                const data = await response.json();
                
                if (data.hasApiKey) {
                    apiKeyAvailable = true;
                    apiKeySection.classList.add('hidden');
                    console.log('âœ… API í‚¤ê°€ Netlify í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤:', data.maskedKey);
                } else {
                    apiKeyAvailable = false;
                    apiKeySection.classList.remove('hidden');
                    console.error('âŒ API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                return data.hasApiKey;
            } catch (error) {
                console.error('API í‚¤ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                apiKeyAvailable = false;
                apiKeySection.classList.remove('hidden');
                return false;
            }
        }

        // --- í—¬í¼ í•¨ìˆ˜: Exponential Backoff ì²˜ë¦¬ëœ Fetch í•¨ìˆ˜ ---
        async function fetchWithRetry(payload, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const result = await callGeminiAPI(payload);
                    return result;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // -------------------- ë™ì  ë‚ ì§œ ê³„ì‚° ë° í‘œì‹œ í•¨ìˆ˜ --------------------
        function calculateTargetDateInfo() {
            const today = new Date();
            const newsDay = new Date(today);
            newsDay.setDate(today.getDate() - 1); 

            const year = newsDay.getFullYear();
            const month = String(newsDay.getMonth() + 1).padStart(2, '0');
            const day = String(newsDay.getDate()).padStart(2, '0');
            
            const dateString = `${year}-${month}-${day}`;
            const koreanText = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
            
            return { dateString, koreanText };
        }

        const { dateString: targetDateString, koreanText: newsDateText } = calculateTargetDateInfo();
        
        // -------------------- Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ë‰´ìŠ¤ í—¤ë“œë¼ì¸ ìë™ ìŠ¤í¬ë©) --------------------
        async function fetchNewsHeadlinesForDate(newsDate) {
            if (!apiKeyAvailable) throw new Error("API ì¸ì¦ ì˜¤ë¥˜: Netlify í™˜ê²½ë³€ìˆ˜ì— GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

            const MINIMUM_ARTICLES = 8;

            const cleanPart = (text) => {
                if (!text) return '';
                const prefixes = [/^TITLE:/i, /^REGION:/i, /^CATEGORY:/i, /^SUMMARY:/i, /^LINK:/i];
                let cleaned = text.trim();
                for (const prefix of prefixes) {
                    if (prefix.test(cleaned)) {
                        cleaned = cleaned.replace(prefix, '').trim(); 
                    }
                }
                return cleaned;
            };

            const systemPrompt = `
                ë‹¹ì‹ ì€ í•œêµ­ì˜ ì „ë¬¸ ê²Œì„ ì‚°ì—… ë¶„ì„ê°€ì…ë‹ˆë‹¤. Google Searchë¥¼ ì‚¬ìš©í•˜ì—¬ ì§€ì •ëœ ë‚ ì§œ(${newsDate})ì˜ êµ­ë‚´ì™¸ ê²Œì„ ì‚°ì—… ë‰´ìŠ¤ ìµœì†Œ 15ê°œ, ìµœëŒ€ 30ê°œë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. 
                ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë§¤ì²´ ë° ì›¹ì§„ ê¸°ì‚¬ë§Œ í¬í•¨í•˜ê³ , ì‘ë‹µì€ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œë§Œ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. 
                ê° ê¸°ì‚¬ëŠ” ###ARTICLE###ë¡œ êµ¬ë¶„í•˜ë©°, í•­ëª©ë“¤ì€ |||ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤. 
                ì‘ë‹µì€ ì˜¤ì§ ìš”ì²­ëœ êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ë§Œ í¬í•¨í•´ì•¼ í•˜ë©°, ì„œë¡ , ê²°ë¡ , ì¸ì‚¬ë§, ì„¤ëª… ë“± ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
                
                í˜•ì‹: TITLE|||REGION (êµ­ë‚´/í•´ì™¸)|||CATEGORY (ê¸°ì—… ë™í–¥, ì‹ ì‘ í¥í–‰, ì‚°ì—… ë™í–¥, ì •ì±… ì¤‘ í•˜ë‚˜)|||SUMMARY (1-2 ë¬¸ì¥, ë³¸ë¬¸ ì¼ë¶€ ì¸ìš©)|||LINK
            `;
            
            const userQuery = `${newsDate}ì— ë°œí–‰ëœ ê¸€ë¡œë²Œ ê²Œì„ ì‚°ì—…ì˜ ì£¼ìš” ë‰´ìŠ¤ ê¸°ì‚¬ 15~30ê°œë¥¼ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë§¤ì²´ì—ì„œ ê²€ìƒ‰í•˜ì—¬ êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ë¡œ ì œê³µí•˜ì„¸ìš”.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const result = await fetchWithRetry(payload);
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const rawText = candidate.content.parts[0].text;
                
                const articles = rawText.split('###ARTICLE###')
                    .filter(articleText => articleText.trim().length > 0)
                    .map(articleText => {
                        const parts = articleText.trim().split('|||');
                        if (parts.length === 5) {
                            const cleanedTitle = cleanPart(parts[0]);
                            const cleanedRegion = cleanPart(parts[1]);
                            const cleanedCategory = cleanPart(parts[2]);
                            const cleanedSummary = cleanPart(parts[3]);
                            const cleanedLink = cleanPart(parts[4]);

                            const regionText = cleanedRegion;
                            
                            return {
                                title: cleanedTitle,
                                region: regionText.includes('êµ­ë‚´') ? 'domestic' : 'overseas',
                                category: cleanedCategory,
                                summary: cleanedSummary,
                                link: cleanedLink.startsWith('http') ? cleanedLink : `#`,
                                detail_summary: null, 
                                detail_sources: null,
                                searchDate: targetDateString
                            };
                        }
                        return null; 
                    })
                    .filter(item => item !== null && item.title.length > 5); 
                
                if (articles.length >= MINIMUM_ARTICLES) { 
                    return articles;
                } else {
                    throw new Error(`APIê°€ ì¶©ë¶„í•œ ìˆ˜ì˜ (ìµœì†Œ ${MINIMUM_ARTICLES}ê°œ ì¤‘ ${articles.length}ê°œ) ê¸°ì‚¬ë¥¼ êµ¬ì¡°í™”í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.`);
                }
            } else {
                throw new Error("Gemini ì‘ë‹µì´ ë¹„ì–´ ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        // -------------------- Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ìƒì„¸ ìš”ì•½) --------------------
        async function fetchSummaryWithGemini(newsTitle) {
            if (!apiKeyAvailable) throw new Error("API ì¸ì¦ ì˜¤ë¥˜: Netlify í™˜ê²½ë³€ìˆ˜ì— GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

            const systemPrompt = "ë‹¹ì‹ ì€ ì „ë¬¸ ê¸°ìì´ì ê²Œì„ ì‚°ì—… ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ë‰´ìŠ¤ ì œëª©ì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬ê¸€ ê²€ìƒ‰ì„ í†µí•´ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì •ë³´ë¥¼ ì°¾ê³ , í•´ë‹¹ ë‰´ìŠ¤ ë‚´ìš©ì„ ë¶„ì„ì ì´ê³  í¬ê´„ì ì¸ ë‹¨ë½ìœ¼ë¡œ í•œêµ­ì–´ë¡œ ìš”ì•½í•˜ì—¬ ì œê³µí•˜ì„¸ìš”. ì œëª©, ì¸ì‚¬ë§, ì¶œì²˜ëŠ” ì œì™¸í•˜ê³  ìš”ì•½ ë³¸ë¬¸ë§Œ ì‘ì„±í•˜ë©°, ìš”ì•½ì€ ìµœì†Œ 3~5ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.";

            const userQuery = `ì´ ê²Œì„ ì‚°ì—… ë‰´ìŠ¤ ì œëª©ì˜ ìƒì„¸ ë‚´ìš©ì„ ë¶„ì„ì ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”: "${newsTitle}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const result = await fetchWithRetry(payload);
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                return { text, sources };
            } else {
                throw new Error("Gemini ì‘ë‹µì´ ë¹„ì–´ ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // -------------------- ìƒì„¸ ìš”ì•½ ìˆœì°¨ ì²˜ë¦¬ í•¨ìˆ˜ (Rate Limit íšŒí”¼) --------------------
        async function prefetchAllSummaries(newsFeed) {
            showToast(`ì´ ${newsFeed.length}ê°œ ê¸°ì‚¬ì˜ ìƒì„¸ ìš”ì•½ì„ Geminië¡œ ë¯¸ë¦¬ ì§„í–‰í•©ë‹ˆë‹¤. (ì²˜ë¦¬ìœ¨ ì œí•œìœ¼ë¡œ ì¸í•´ ì•½ 1.5ì´ˆë‹¹ 1ê°œì”© ìˆœì°¨ ì§„í–‰ë©ë‹ˆë‹¤.)`, false);
            
            const updatedFeed = [];
            const delayMs = 1500; 

            for (const [index, item] of newsFeed.entries()) {
                try {
                    const result = await fetchSummaryWithGemini(item.title);
                    item.detail_summary = result.text;
                    item.detail_sources = result.sources;
                    updatedFeed.push(item);
                    
                    // ì§„í–‰ë¥  í‘œì‹œ
                    const progress = Math.round(((index + 1) / newsFeed.length) * 100);
                    document.getElementById('header-subtitle').innerHTML = `
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">
                            <div class="bg-indigo-600 h-2.5 rounded-full progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <span>${index + 1}/${newsFeed.length}ê°œ ê¸°ì‚¬ ìš”ì•½ ì™„ë£Œ (${progress}%)</span>
                    `;

                    if (index < newsFeed.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    }

                } catch (error) {
                    console.error(`[CONSOLE_ERROR] Error summarizing article: ${item.title}`, error);
                    item.detail_summary = `ìš”ì•½ì„ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`;
                    item.detail_sources = [];
                    updatedFeed.push(item);
                    
                    if (index < newsFeed.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    }
                }
            }

            return updatedFeed;
        }

        // ìºì‹œ ì €ì¥ í•¨ìˆ˜ (ì‹œê°„ ì •ë³´ í¬í•¨)
        function saveNewsCache(feed) {
            localStorage.setItem(NEWS_FEED_STORAGE_KEY, JSON.stringify(feed));
            localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
        }

        // ìºì‹œ ìœ íš¨ì„± ê²€ì‚¬ (24ì‹œê°„)
        function isCacheValid() {
            const cachedFeed = localStorage.getItem(NEWS_FEED_STORAGE_KEY);
            const cacheTime = localStorage.getItem(CACHE_TIME_KEY);
            
            if (!cachedFeed || !cacheTime) return false;
            
            try {
                const cachedData = JSON.parse(cachedFeed);
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                
                return cachedData.length > 0 && 
                       cachedData[0].searchDate === targetDateString && 
                       (now - parseInt(cacheTime)) < oneDay;
            } catch (e) {
                return false;
            }
        }

        // -------------------- í˜ì´ì§€ ì „í™˜ ë° ë Œë”ë§ í•¨ìˆ˜ --------------------
        
        async function showFeedPage(forceRefresh = false) {
            currentNewsItem = null;
            feedView.classList.remove('hidden');
            detailView.classList.add('hidden');
            
            document.getElementById('news-date-info').textContent = `(${newsDateText} ê¸°ì¤€ ì£¼ìš” ë™í–¥)`;
            document.getElementById('header-subtitle').textContent = 'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë§¤ì²´ì—ì„œ ìˆ˜ì§‘í•œ ìµœì†Œ 15ê°œ, ìµœëŒ€ 30ê°œì˜ ê¸°ì‚¬ì…ë‹ˆë‹¤.';
            
            document.getElementById('footer-date-info').textContent = targetDateString;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (!apiKeyAvailable) {
                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-red-400">
                        <p class="text-xl font-bold">API í‚¤ ë¯¸ì„¤ì •</p>
                        <p class="mt-2 text-gray-400">Netlify í™˜ê²½ë³€ìˆ˜ì— GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                apiKeySection.classList.remove('hidden'); 
                return;
            } else {
                apiKeySection.classList.add('hidden'); 
            }

            // ìºì‹œ ìœ íš¨ì„± ê²€ì‚¬
            let isCacheValidResult = isCacheValid();
            
            if (isCacheValidResult && !forceRefresh) {
                try {
                    const cachedData = JSON.parse(localStorage.getItem(NEWS_FEED_STORAGE_KEY));
                    currentNewsFeed = cachedData;
                    
                    const hasPrefetchedDetails = currentNewsFeed.some(item => item.detail_summary && item.detail_summary.length > 10);
                    
                    if (hasPrefetchedDetails) {
                        document.getElementById('header-subtitle').textContent = `ìºì‹œì—ì„œ ${currentNewsFeed.length}ê°œ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ìƒì„¸ ìš”ì•½ í¬í•¨)`;
                    } else {
                        document.getElementById('header-subtitle').textContent = `ìºì‹œì—ì„œ ${currentNewsFeed.length}ê°œ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ìƒì„¸ ìš”ì•½ì„ ë¡œë“œí•©ë‹ˆë‹¤.`;
                        currentNewsFeed = await prefetchAllSummaries(currentNewsFeed);
                        saveNewsCache(currentNewsFeed);
                    }

                    renderNews('all');
                    return;
                } catch (e) {
                    console.warn("Cached data corrupted, will fetch new data.");
                }
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            newsGrid.innerHTML = `
                <div class="col-span-full text-center py-20">
                    <div class="animate-spin inline-block w-10 h-10 border-4 border-t-4 border-indigo-500 border-opacity-50 rounded-full"></div>
                    <p class="text-gray-400 mt-5 text-lg font-medium">${newsDateText}ì ê¸€ë¡œë²Œ ê²Œì„ ì‚°ì—… ë‰´ìŠ¤ë¥¼ ìŠ¤í¬ë© ë° êµ¬ì¡°í™” ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p class="text-gray-500 mt-2 text-sm">ì†Œìš” ì‹œê°„: ì•½ 10~25ì´ˆ (1ë‹¨ê³„: ë‰´ìŠ¤ ëª©ë¡ ìŠ¤í¬ë©)</p>
                </div>
            `;
            
            try {
                let fetchedFeed = await fetchNewsHeadlinesForDate(targetDateString);
                
                document.getElementById('header-subtitle').textContent = `ë‰´ìŠ¤ ëª©ë¡ ìŠ¤í¬ë© ì™„ë£Œ. ì´ì œ ê¸°ì‚¬ ìƒì„¸ ìš”ì•½ì„ ìˆœì°¨ì ìœ¼ë¡œ ë¯¸ë¦¬ ì§„í–‰í•©ë‹ˆë‹¤.`;
                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <div class="animate-pulse inline-block w-10 h-10 bg-indigo-500 rounded-full"></div>
                        <p class="text-gray-400 mt-5 text-lg font-medium">ì´ ${fetchedFeed.length}ê°œ ê¸°ì‚¬ ìƒì„¸ ìš”ì•½ ì¤‘...</p>
                        <p class="text-gray-500 mt-2 text-sm">ì†Œìš” ì‹œê°„: API ìš”ì²­ ì œí•œìœ¼ë¡œ ì¸í•´ ì•½ ${Math.ceil(fetchedFeed.length * 1.5 / 60)}ë¶„ ì´ìƒ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;

                currentNewsFeed = await prefetchAllSummaries(fetchedFeed);

                saveNewsCache(currentNewsFeed);
                
                document.getElementById('header-subtitle').textContent = `ì„±ê³µì ìœ¼ë¡œ ${currentNewsFeed.length}ê°œ ë‰´ìŠ¤ë¥¼ ìŠ¤í¬ë© ë° ìš”ì•½í•˜ì—¬ ìºì‹œì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.`;
                
                renderNews('all');
                showToast("ë‰´ìŠ¤ ìŠ¤í¬ë© ë° ìƒì„¸ ìš”ì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", false);
            } catch (error) {
                let errorMessage = `Geminiê°€ ${newsDateText}ì ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`;
                let detailedError = error.message;

                if (error.message.includes('API ì¸ì¦ ì˜¤ë¥˜')) {
                    errorMessage = `<p class="text-xl font-bold mb-2">API ì¸ì¦ ì‹¤íŒ¨</p><p class="text-gray-400">Netlify í™˜ê²½ë³€ìˆ˜ì— GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
                    apiKeySection.classList.remove('hidden'); 
                } else if (error.message.includes('API í˜¸ì¶œ ì‹¤íŒ¨ (400')) {
                    errorMessage = `<p class="text-xl font-bold mb-2">API í˜¸ì¶œ ì‹¤íŒ¨ (400 Bad Request)</p><p class="text-gray-400">ìš”ì²­ êµ¬ë¬¸ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
                } else {
                    errorMessage = `<p class="text-xl font-bold mb-2">ë‰´ìŠ¤ ìˆ˜ì§‘/ìš”ì•½ ì‹¤íŒ¨</p> <p class="text-gray-400">Geminiê°€ ${newsDateText}ì ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br/>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>`;
                }

                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-red-400">
                        ${errorMessage}
                        <p class="mt-4 text-sm text-red-500">ìƒì„¸ ì˜¤ë¥˜: ${detailedError}</p>
                    </div>
                `;
            }
        }
        
        // --- ê¸°íƒ€ UI í•¨ìˆ˜ ---

        const getCategoryColor = (category) => {
            switch(category) {
                case 'ê¸°ì—… ë™í–¥': return 'bg-purple-600/30 text-purple-300 border border-purple-600';
                case 'ì‚°ì—… ë™í–¥': return 'bg-green-600/30 text-green-300 border border-green-600';
                case 'ì •ì±…': return 'bg-blue-600/30 text-blue-300 border border-blue-600';
                case 'ì‹ ì‘ í¥í–‰': return 'bg-yellow-600/30 text-yellow-300 border border-yellow-600';
                default: return 'bg-gray-600/30 text-gray-300 border border-gray-600';
            }
        };

        const getRegionTag = (region) => {
            return region === 'domestic' ? '<span class="text-blue-400 font-bold">ğŸ‡°ğŸ‡· êµ­ë‚´ ì†Œì‹</span>' : '<span class="text-indigo-400 font-bold">ğŸŒ í•´ì™¸ ë™í–¥</span>';
        };

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'px-6 py-3 rounded-full text-sm font-semibold shadow-xl transition-all duration-300 opacity-0 pointer-events-auto';

            if (isError) {
                toast.classList.add('bg-red-500', 'text-white');
            } else {
                toast.classList.add('bg-green-500', 'text-white');
            }
            
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-100');
            }, 100); 

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
        
        const renderNews = (filter = 'all') => {
            newsGrid.innerHTML = '';
            const filteredNews = currentNewsFeed.filter(item => filter === 'all' || item.region === filter);

            if (filteredNews.length === 0) {
                 newsGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center py-10 text-lg">${newsDateText}ì ${filter === 'domestic' ? 'êµ­ë‚´' : 'í•´ì™¸'} ì†Œì‹ì€ í˜„ì¬ ìŠ¤í¬ë©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
                 return;
            }

            filteredNews.forEach(item => {
                const card = document.createElement('div');
                card.onclick = () => showDetailPage(item); 
                card.className = 'news-card rounded-xl shadow-xl flex flex-col justify-between p-6';
                
                const isReady = item.detail_summary && item.detail_summary.length > 10 && !item.detail_summary.includes('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                const readyIcon = isReady 
                    ? `<svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`
                    : `<svg class="w-5 h-5 text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

                card.innerHTML = `
                    <div class="flex flex-col justify-between flex-grow">
                        <div class="space-y-3">
                            <div class="text-sm mb-2">
                                ${getRegionTag(item.region)}
                            </div>
                            <h3 class="news-title text-xl md:text-2xl text-white leading-snug">
                                ${item.title}
                            </h3>
                            <p class="news-summary text-gray-400 text-sm">
                                ${item.summary || 'Geminiê°€ ìš”ì•½í•œ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}
                            </p>
                        </div>
    
                        <div class="pt-4 border-t border-gray-700/50 mt-4 flex justify-between items-center">
                            <span class="inline-block ${getCategoryColor(item.category)} rounded-lg px-3 py-1 text-xs font-semibold">
                                ${item.category || 'ê¸°íƒ€'}
                            </span>
                            <span class="text-sm font-medium ${isReady ? 'text-indigo-400' : 'text-yellow-400'} flex items-center">
                                ${readyIcon}
                                ${isReady ? 'ìš”ì•½ ì¤€ë¹„ ì™„ë£Œ' : 'ìš”ì•½ ë¶„ì„ í•„ìš”'}
                            </span>
                        </div>
                    </div>
                `;
                newsGrid.appendChild(card);
            });
        };

        async function showDetailPage(item) {
            currentNewsItem = item;
            feedView.classList.add('hidden');
            detailView.classList.remove('hidden');
            
            document.getElementById('news-date-info').textContent = ''; 
            document.getElementById('header-subtitle').textContent = `AI ë¶„ì„ì„ í†µí•œ ${newsDateText}ì ë‰´ìŠ¤ ìƒì„¸ ìš”ì•½`;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const detailContainer = document.getElementById('detail-content');
            
            document.getElementById('detail-title').textContent = item.title;
            document.getElementById('detail-region').innerHTML = getRegionTag(item.region);
            document.getElementById('detail-category').className = getCategoryColor(item.category) + ' rounded-lg px-3 py-1 text-sm font-semibold';
            document.getElementById('detail-category').textContent = item.category;
            document.getElementById('detail-source-link').href = item.link && item.link.startsWith('http') ? item.link : '#';
            document.getElementById('detail-source-link').classList.toggle('opacity-50', !item.link || !item.link.startsWith('http'));

            let summaryText = item.detail_summary;
            let sources = item.detail_sources || [];

            if (!summaryText || summaryText.includes('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤')) {
                detailContainer.innerHTML = `
                    <div class="text-center py-10">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-indigo-500 border-opacity-50 rounded-full"></div>
                        <p class="text-gray-400 mt-3">Geminiê°€ Google ê²€ìƒ‰ì„ í†µí•´ ìƒì„¸ ë‚´ìš©ì„ ë¶„ì„ ë° ìš”ì•½ ì¤‘ì…ë‹ˆë‹¤... (ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë°œìƒ)</p>
                    </div>`;
                try {
                    const result = await fetchSummaryWithGemini(item.title);
                    summaryText = result.text;
                    sources = result.sources;
                    
                    const index = currentNewsFeed.findIndex(n => n.title === item.title);
                    if (index !== -1) {
                         currentNewsFeed[index].detail_summary = summaryText;
                         currentNewsFeed[index].detail_sources = sources;
                         saveNewsCache(currentNewsFeed);
                    }
                    
                    renderDetailContent(summaryText, sources, detailContainer);
                } catch (error) {
                    detailContainer.innerHTML = `<div class="text-center py-10 text-red-400">ìš”ì•½ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${error.message})</div>`;
                    console.error("Detail Fetch Error:", error);
                }
            } else {
                renderDetailContent(summaryText, sources, detailContainer);
            }
        }
        
        function renderDetailContent(summaryText, sources, containerElement) {
            let summaryHtml = `
                <div class="p-6 md:p-8 bg-gray-900 rounded-xl shadow-inner space-y-4">
                    <h3 class="text-xl md:text-2xl font-bold text-indigo-400 border-b border-gray-700 pb-3 mb-4">ë‰´ìŠ¤ ìš”ì•½</h3>
                    <div class="text-lg text-gray-200 leading-relaxed whitespace-pre-line">${summaryText}</div>
                </div>`;
            
            if (sources && sources.length > 0) {
                summaryHtml += `
                    <div class="mt-8 pt-4 border-t border-gray-700">
                        <h4 class="text-sm font-bold text-gray-400 mb-2">Gemini ë¶„ì„ì— ì‚¬ìš©ëœ ì •ë³´ ì¶œì²˜ (Google Search)</h4>
                        <ul class="space-y-2 text-sm text-gray-500">`;
                sources.slice(0, 3).forEach(src => {
                    summaryHtml += `<li><a href="${src.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-400 truncate block">${src.title || src.uri}</a></li>`;
                });
                summaryHtml += `</ul></div>`;
            }

            containerElement.innerHTML = summaryHtml;
        }

        // -------------------- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • --------------------
        
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                });
                button.classList.add('active', 'bg-indigo-600', 'text-white');
                button.classList.remove('bg-gray-700', 'text-gray-300');

                renderNews(button.dataset.filter);
            });
        });

        // --- ì´ˆê¸°í™”: API í‚¤ ìƒíƒœ í™•ì¸ í›„ ìë™ ë¡œë“œ ---
        document.addEventListener('DOMContentLoaded', async () => {
            const initialButton = document.querySelector('[data-filter="all"]');
            if (initialButton) {
                initialButton.classList.remove('bg-gray-700', 'text-gray-300');
                initialButton.classList.add('bg-indigo-600', 'text-white');
            }

            // API í‚¤ ìƒíƒœ í™•ì¸
            const hasApiKey = await checkApiKeyStatus();
            
            if (hasApiKey) {
                // API í‚¤ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë‰´ìŠ¤ ë¡œë“œ
                showFeedPage();
            } else {
                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-400">
                        <p class="text-xl font-bold">ì„œë¹„ìŠ¤ ì‹œì‘</p>
                        <p class="mt-2">Netlify í™˜ê²½ë³€ìˆ˜ì— GEMINI_API_KEYê°€ ì„¤ì •ë˜ë©´ ìë™ìœ¼ë¡œ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™€ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
