<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글로벌 게임 산업 카드 뉴스 피드 (사전 요약)</title>
    <meta name="description" content="AI 기반 글로벌 게임 산업 뉴스 분석 서비스">
    <meta name="keywords" content="게임뉴스, AI분석, 게임산업, 뉴스요약">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .news-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #2d3748;
            cursor: pointer;
        }
        .news-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.4);
        }
        .news-title {
            font-weight: 900;
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .news-summary {
            display: -webkit-box;
            -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.6;
        }
        .filter-btn.active {
            background-color: #7B68EE;
            color: #FFFFFF;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(123, 104, 238, 0.5);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10 mt-4 md:mt-0">
            <h1 class="text-3xl md:text-4xl font-extrabold text-[#7B68EE] mb-2">
                🎮 글로벌 게임 산업 인사이트 스크랩
            </h1>
            <p id="news-date-info" class="text-lg md:text-xl font-semibold text-gray-300 mb-2"></p> 
            <p id="header-subtitle" class="text-gray-400 text-md md:text-lg">신뢰할 수 있는 매체에서 수집한 최소 15개, 최대 30개의 기사입니다.</p>
        </header>

        <section id="api-key-section" class="bg-gray-800 p-5 rounded-xl shadow-xl mb-10 border hidden">
            <h2 class="text-xl font-bold text-red-400 mb-3">⚠️ API 키 설정 오류</h2>
            <div class="text-center">
                <p class="text-gray-400 mb-4">Netlify 환경변수에 GEMINI_API_KEY가 설정되지 않았습니다.</p>
                <p class="text-sm text-gray-500">관리자에게 문의하거나 Netlify 대시보드에서 환경변수를 확인해주세요.</p>
            </div>
        </section>

        <main id="feed-view">
            <section id="filters" class="flex justify-center space-x-2 md:space-x-4 mb-10 overflow-x-auto pb-3 border-b border-gray-700">
                <button class="filter-btn active text-sm md:text-base bg-gray-700 text-gray-300 py-2 px-4 md:px-6 rounded-full hover:bg-gray-600" data-filter="all" aria-label="전체 뉴스 보기">
                    전체 동향
                </button>
                <button class="filter-btn text-sm md:text-base bg-gray-700 text-gray-300 py-2 px-4 md:px-6 rounded-full hover:bg-gray-600" data-filter="domestic" aria-label="국내 뉴스 보기">
                    국내 소식 🇰🇷
                </button>
                <button class="filter-btn text-sm md:text-base bg-gray-700 text-gray-300 py-2 px-4 md:px-6 rounded-full hover:bg-gray-600" data-filter="overseas" aria-label="해외 뉴스 보기">
                    해외 소식 🌎
                </button>
            </section>

            <section id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 md:gap-8 min-h-[400px]">
            </section>
        </main>

        <div id="detail-view" class="hidden">
            <button onclick="showFeedPage()" class="flex items-center text-indigo-400 hover:text-white mb-6 transition-colors" aria-label="목록으로 돌아가기">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                목록으로 돌아가기
            </button>
            
            <article class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl mb-10">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center border-b border-gray-700 pb-4 mb-6">
                    <div>
                        <div id="detail-region" class="text-xl font-bold mb-2"></div>
                        <span id="detail-category" class="inline-block rounded-lg px-3 py-1 text-sm font-semibold"></span>
                    </div>
                    <div class="mt-4 md:mt-0 flex space-x-3">
                        <a id="detail-source-link" target="_blank" rel="noopener noreferrer" 
                           class="flex items-center text-sm font-medium text-gray-300 transition-colors bg-gray-600 px-4 py-2 rounded-full hover:bg-gray-700 shadow-lg"
                           aria-label="원본 기사 보기">
                           <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            원본 기사 보기
                        </a>
                    </div>
                </div>

                <h2 id="detail-title" class="text-3xl md:text-4xl font-extrabold text-white mb-6 leading-tight"></h2>
                
                <div id="detail-content" class="min-h-[200px] flex flex-col justify-center">
                </div>
            </article>
        </div>

        <div id="toast-container" class="fixed bottom-0 inset-x-0 p-4 flex items-center justify-center pointer-events-none z-50"></div>

        <footer class="text-center mt-12 py-6 border-t border-gray-700">
            <p class="text-gray-500 text-xs md:text-sm">출처: Gemini 및 Google Search 실시간 분석 (<span id="footer-date-info"></span> 뉴스 기준).</p>
        </footer>
    </div>

    <script>
        // 전역 변수 설정
        const NEWS_FEED_STORAGE_KEY = 'geminiNewsFeed';
        const CACHE_TIME_KEY = 'newsCacheTime';
        let apiKeyAvailable = false;

        // 상태 관리
        let currentNewsItem = null; 
        let currentNewsFeed = []; 

        // UI 요소
        const newsGrid = document.getElementById('news-grid');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const toastContainer = document.getElementById('toast-container');
        const detailView = document.getElementById('detail-view');
        const feedView = document.getElementById('feed-view');
        const apiKeySection = document.getElementById('api-key-section');
        
        // --- Netlify Functions API 호출 함수 ---
        async function callGeminiAPI(payload) {
            try {
                const response = await fetch('/api/gemini-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'API 호출 실패');
                }

                return await response.json();
            } catch (error) {
                console.error('API 호출 오류:', error);
                throw error;
            }
        }

        // --- API 키 상태 확인 ---
        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/api/config-status');
                const data = await response.json();
                
                if (data.hasApiKey) {
                    apiKeyAvailable = true;
                    apiKeySection.classList.add('hidden');
                    console.log('✅ API 키가 Netlify 환경변수에서 로드되었습니다:', data.maskedKey);
                } else {
                    apiKeyAvailable = false;
                    apiKeySection.classList.remove('hidden');
                    console.error('❌ API 키를 찾을 수 없습니다.');
                }
                
                return data.hasApiKey;
            } catch (error) {
                console.error('API 키 상태 확인 실패:', error);
                apiKeyAvailable = false;
                apiKeySection.classList.remove('hidden');
                return false;
            }
        }

        // --- 헬퍼 함수: Exponential Backoff 처리된 Fetch 함수 ---
        async function fetchWithRetry(payload, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const result = await callGeminiAPI(payload);
                    return result;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // -------------------- 동적 날짜 계산 및 표시 함수 --------------------
        function calculateTargetDateInfo() {
            const today = new Date();
            const newsDay = new Date(today);
            newsDay.setDate(today.getDate() - 1); 

            const year = newsDay.getFullYear();
            const month = String(newsDay.getMonth() + 1).padStart(2, '0');
            const day = String(newsDay.getDate()).padStart(2, '0');
            
            const dateString = `${year}-${month}-${day}`;
            const koreanText = `${year}년 ${parseInt(month)}월 ${parseInt(day)}일`;
            
            return { dateString, koreanText };
        }

        const { dateString: targetDateString, koreanText: newsDateText } = calculateTargetDateInfo();
        
        // -------------------- Gemini API 호출 함수 (뉴스 헤드라인 자동 스크랩) --------------------
        async function fetchNewsHeadlinesForDate(newsDate) {
            if (!apiKeyAvailable) throw new Error("API 인증 오류: Netlify 환경변수에 GEMINI_API_KEY가 설정되지 않았습니다.");

            const MINIMUM_ARTICLES = 8;

            const cleanPart = (text) => {
                if (!text) return '';
                const prefixes = [/^TITLE:/i, /^REGION:/i, /^CATEGORY:/i, /^SUMMARY:/i, /^LINK:/i];
                let cleaned = text.trim();
                for (const prefix of prefixes) {
                    if (prefix.test(cleaned)) {
                        cleaned = cleaned.replace(prefix, '').trim(); 
                    }
                }
                return cleaned;
            };

            const systemPrompt = `
                당신은 한국의 전문 게임 산업 분석가입니다. Google Search를 사용하여 지정된 날짜(${newsDate})의 국내외 게임 산업 뉴스 최소 15개, 최대 30개를 찾아야 합니다. 
                신뢰할 수 있는 매체 및 웹진 기사만 포함하고, 응답은 다음 형식으로만 제공해야 합니다. 
                각 기사는 ###ARTICLE###로 구분하며, 항목들은 |||로 구분합니다. 
                응답은 오직 요청된 구조화된 텍스트만 포함해야 하며, 서론, 결론, 인사말, 설명 등 다른 텍스트는 절대 포함하지 마세요.
                
                형식: TITLE|||REGION (국내/해외)|||CATEGORY (기업 동향, 신작 흥행, 산업 동향, 정책 중 하나)|||SUMMARY (1-2 문장, 본문 일부 인용)|||LINK
            `;
            
            const userQuery = `${newsDate}에 발행된 글로벌 게임 산업의 주요 뉴스 기사 15~30개를 신뢰할 수 있는 매체에서 검색하여 구조화된 텍스트로 제공하세요.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const result = await fetchWithRetry(payload);
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const rawText = candidate.content.parts[0].text;
                
                const articles = rawText.split('###ARTICLE###')
                    .filter(articleText => articleText.trim().length > 0)
                    .map(articleText => {
                        const parts = articleText.trim().split('|||');
                        if (parts.length === 5) {
                            const cleanedTitle = cleanPart(parts[0]);
                            const cleanedRegion = cleanPart(parts[1]);
                            const cleanedCategory = cleanPart(parts[2]);
                            const cleanedSummary = cleanPart(parts[3]);
                            const cleanedLink = cleanPart(parts[4]);

                            const regionText = cleanedRegion;
                            
                            return {
                                title: cleanedTitle,
                                region: regionText.includes('국내') ? 'domestic' : 'overseas',
                                category: cleanedCategory,
                                summary: cleanedSummary,
                                link: cleanedLink.startsWith('http') ? cleanedLink : `#`,
                                detail_summary: null, 
                                detail_sources: null,
                                searchDate: targetDateString
                            };
                        }
                        return null; 
                    })
                    .filter(item => item !== null && item.title.length > 5); 
                
                if (articles.length >= MINIMUM_ARTICLES) { 
                    return articles;
                } else {
                    throw new Error(`API가 충분한 수의 (최소 ${MINIMUM_ARTICLES}개 중 ${articles.length}개) 기사를 구조화하지 못했습니다. 응답 텍스트를 확인해 주세요.`);
                }
            } else {
                throw new Error("Gemini 응답이 비어 있거나 형식이 잘못되었습니다.");
            }
        }

        // -------------------- Gemini API 호출 함수 (상세 요약) --------------------
        async function fetchSummaryWithGemini(newsTitle) {
            if (!apiKeyAvailable) throw new Error("API 인증 오류: Netlify 환경변수에 GEMINI_API_KEY가 설정되지 않았습니다.");

            const systemPrompt = "당신은 전문 기자이자 게임 산업 분석가입니다. 제공된 뉴스 제목을 기반으로 구글 검색을 통해 신뢰할 수 있는 정보를 찾고, 해당 뉴스 내용을 분석적이고 포괄적인 단락으로 한국어로 요약하여 제공하세요. 제목, 인사말, 출처는 제외하고 요약 본문만 작성하며, 요약은 최소 3~5문장 이상으로 상세하게 작성해야 합니다.";

            const userQuery = `이 게임 산업 뉴스 제목의 상세 내용을 분석적으로 요약해 주세요: "${newsTitle}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const result = await fetchWithRetry(payload);
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                return { text, sources };
            } else {
                throw new Error("Gemini 응답이 비어 있거나 형식이 잘못되었습니다.");
            }
        }
        
        // -------------------- 상세 요약 순차 처리 함수 (Rate Limit 회피) --------------------
        async function prefetchAllSummaries(newsFeed) {
            showToast(`총 ${newsFeed.length}개 기사의 상세 요약을 Gemini로 미리 진행합니다. (처리율 제한으로 인해 약 1.5초당 1개씩 순차 진행됩니다.)`, false);
            
            const updatedFeed = [];
            const delayMs = 1500; 

            for (const [index, item] of newsFeed.entries()) {
                try {
                    const result = await fetchSummaryWithGemini(item.title);
                    item.detail_summary = result.text;
                    item.detail_sources = result.sources;
                    updatedFeed.push(item);
                    
                    // 진행률 표시
                    const progress = Math.round(((index + 1) / newsFeed.length) * 100);
                    document.getElementById('header-subtitle').innerHTML = `
                        <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">
                            <div class="bg-indigo-600 h-2.5 rounded-full progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <span>${index + 1}/${newsFeed.length}개 기사 요약 완료 (${progress}%)</span>
                    `;

                    if (index < newsFeed.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    }

                } catch (error) {
                    console.error(`[CONSOLE_ERROR] Error summarizing article: ${item.title}`, error);
                    item.detail_summary = `요약을 미리 불러오는 중 오류가 발생했습니다: ${error.message}. 잠시 후 다시 시도해 주세요.`;
                    item.detail_sources = [];
                    updatedFeed.push(item);
                    
                    if (index < newsFeed.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, delayMs));
                    }
                }
            }

            return updatedFeed;
        }

        // 캐시 저장 함수 (시간 정보 포함)
        function saveNewsCache(feed) {
            localStorage.setItem(NEWS_FEED_STORAGE_KEY, JSON.stringify(feed));
            localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
        }

        // 캐시 유효성 검사 (24시간)
        function isCacheValid() {
            const cachedFeed = localStorage.getItem(NEWS_FEED_STORAGE_KEY);
            const cacheTime = localStorage.getItem(CACHE_TIME_KEY);
            
            if (!cachedFeed || !cacheTime) return false;
            
            try {
                const cachedData = JSON.parse(cachedFeed);
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                
                return cachedData.length > 0 && 
                       cachedData[0].searchDate === targetDateString && 
                       (now - parseInt(cacheTime)) < oneDay;
            } catch (e) {
                return false;
            }
        }

        // -------------------- 페이지 전환 및 렌더링 함수 --------------------
        
        async function showFeedPage(forceRefresh = false) {
            currentNewsItem = null;
            feedView.classList.remove('hidden');
            detailView.classList.add('hidden');
            
            document.getElementById('news-date-info').textContent = `(${newsDateText} 기준 주요 동향)`;
            document.getElementById('header-subtitle').textContent = '신뢰할 수 있는 매체에서 수집한 최소 15개, 최대 30개의 기사입니다.';
            
            document.getElementById('footer-date-info').textContent = targetDateString;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (!apiKeyAvailable) {
                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-red-400">
                        <p class="text-xl font-bold">API 키 미설정</p>
                        <p class="mt-2 text-gray-400">Netlify 환경변수에 GEMINI_API_KEY가 설정되지 않았습니다.</p>
                    </div>
                `;
                apiKeySection.classList.remove('hidden'); 
                return;
            } else {
                apiKeySection.classList.add('hidden'); 
            }

            // 캐시 유효성 검사
            let isCacheValidResult = isCacheValid();
            
            if (isCacheValidResult && !forceRefresh) {
                try {
                    const cachedData = JSON.parse(localStorage.getItem(NEWS_FEED_STORAGE_KEY));
                    currentNewsFeed = cachedData;
                    
                    const hasPrefetchedDetails = currentNewsFeed.some(item => item.detail_summary && item.detail_summary.length > 10);
                    
                    if (hasPrefetchedDetails) {
                        document.getElementById('header-subtitle').textContent = `캐시에서 ${currentNewsFeed.length}개 뉴스를 불러왔습니다. (상세 요약 포함)`;
                    } else {
                        document.getElementById('header-subtitle').textContent = `캐시에서 ${currentNewsFeed.length}개 뉴스를 불러왔습니다. 상세 요약을 로드합니다.`;
                        currentNewsFeed = await prefetchAllSummaries(currentNewsFeed);
                        saveNewsCache(currentNewsFeed);
                    }

                    renderNews('all');
                    return;
                } catch (e) {
                    console.warn("Cached data corrupted, will fetch new data.");
                }
            }

            // 로딩 상태 표시
            newsGrid.innerHTML = `
                <div class="col-span-full text-center py-20">
                    <div class="animate-spin inline-block w-10 h-10 border-4 border-t-4 border-indigo-500 border-opacity-50 rounded-full"></div>
                    <p class="text-gray-400 mt-5 text-lg font-medium">${newsDateText}자 글로벌 게임 산업 뉴스를 스크랩 및 구조화 중입니다...</p>
                    <p class="text-gray-500 mt-2 text-sm">소요 시간: 약 10~25초 (1단계: 뉴스 목록 스크랩)</p>
                </div>
            `;
            
            try {
                let fetchedFeed = await fetchNewsHeadlinesForDate(targetDateString);
                
                document.getElementById('header-subtitle').textContent = `뉴스 목록 스크랩 완료. 이제 기사 상세 요약을 순차적으로 미리 진행합니다.`;
                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <div class="animate-pulse inline-block w-10 h-10 bg-indigo-500 rounded-full"></div>
                        <p class="text-gray-400 mt-5 text-lg font-medium">총 ${fetchedFeed.length}개 기사 상세 요약 중...</p>
                        <p class="text-gray-500 mt-2 text-sm">소요 시간: API 요청 제한으로 인해 약 ${Math.ceil(fetchedFeed.length * 1.5 / 60)}분 이상 소요될 수 있습니다.</p>
                    </div>
                `;

                currentNewsFeed = await prefetchAllSummaries(fetchedFeed);

                saveNewsCache(currentNewsFeed);
                
                document.getElementById('header-subtitle').textContent = `성공적으로 ${currentNewsFeed.length}개 뉴스를 스크랩 및 요약하여 캐시에 저장했습니다.`;
                
                renderNews('all');
                showToast("뉴스 스크랩 및 상세 요약이 완료되었습니다!", false);
            } catch (error) {
                let errorMessage = `Gemini가 ${newsDateText}자 뉴스를 가져오는 데 실패했습니다.`;
                let detailedError = error.message;

                if (error.message.includes('API 인증 오류')) {
                    errorMessage = `<p class="text-xl font-bold mb-2">API 인증 실패</p><p class="text-gray-400">Netlify 환경변수에 GEMINI_API_KEY가 설정되지 않았습니다.</p>`;
                    apiKeySection.classList.remove('hidden'); 
                } else if (error.message.includes('API 호출 실패 (400')) {
                    errorMessage = `<p class="text-xl font-bold mb-2">API 호출 실패 (400 Bad Request)</p><p class="text-gray-400">요청 구문에 오류가 있습니다. 서버에 일시적인 문제가 있을 수 있습니다.</p>`;
                } else {
                    errorMessage = `<p class="text-xl font-bold mb-2">뉴스 수집/요약 실패</p> <p class="text-gray-400">Gemini가 ${newsDateText}자 뉴스를 가져오는 데 실패했습니다. <br/>잠시 후 다시 시도해 주세요.</p>`;
                }

                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-red-400">
                        ${errorMessage}
                        <p class="mt-4 text-sm text-red-500">상세 오류: ${detailedError}</p>
                    </div>
                `;
            }
        }
        
        // --- 기타 UI 함수 ---

        const getCategoryColor = (category) => {
            switch(category) {
                case '기업 동향': return 'bg-purple-600/30 text-purple-300 border border-purple-600';
                case '산업 동향': return 'bg-green-600/30 text-green-300 border border-green-600';
                case '정책': return 'bg-blue-600/30 text-blue-300 border border-blue-600';
                case '신작 흥행': return 'bg-yellow-600/30 text-yellow-300 border border-yellow-600';
                default: return 'bg-gray-600/30 text-gray-300 border border-gray-600';
            }
        };

        const getRegionTag = (region) => {
            return region === 'domestic' ? '<span class="text-blue-400 font-bold">🇰🇷 국내 소식</span>' : '<span class="text-indigo-400 font-bold">🌎 해외 동향</span>';
        };

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'px-6 py-3 rounded-full text-sm font-semibold shadow-xl transition-all duration-300 opacity-0 pointer-events-auto';

            if (isError) {
                toast.classList.add('bg-red-500', 'text-white');
            } else {
                toast.classList.add('bg-green-500', 'text-white');
            }
            
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-100');
            }, 100); 

            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
        
        const renderNews = (filter = 'all') => {
            newsGrid.innerHTML = '';
            const filteredNews = currentNewsFeed.filter(item => filter === 'all' || item.region === filter);

            if (filteredNews.length === 0) {
                 newsGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center py-10 text-lg">${newsDateText}자 ${filter === 'domestic' ? '국내' : '해외'} 소식은 현재 스크랩되지 않았습니다.</p>`;
                 return;
            }

            filteredNews.forEach(item => {
                const card = document.createElement('div');
                card.onclick = () => showDetailPage(item); 
                card.className = 'news-card rounded-xl shadow-xl flex flex-col justify-between p-6';
                
                const isReady = item.detail_summary && item.detail_summary.length > 10 && !item.detail_summary.includes('오류가 발생했습니다');
                const readyIcon = isReady 
                    ? `<svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`
                    : `<svg class="w-5 h-5 text-yellow-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;

                card.innerHTML = `
                    <div class="flex flex-col justify-between flex-grow">
                        <div class="space-y-3">
                            <div class="text-sm mb-2">
                                ${getRegionTag(item.region)}
                            </div>
                            <h3 class="news-title text-xl md:text-2xl text-white leading-snug">
                                ${item.title}
                            </h3>
                            <p class="news-summary text-gray-400 text-sm">
                                ${item.summary || 'Gemini가 요약한 내용이 없습니다.'}
                            </p>
                        </div>
    
                        <div class="pt-4 border-t border-gray-700/50 mt-4 flex justify-between items-center">
                            <span class="inline-block ${getCategoryColor(item.category)} rounded-lg px-3 py-1 text-xs font-semibold">
                                ${item.category || '기타'}
                            </span>
                            <span class="text-sm font-medium ${isReady ? 'text-indigo-400' : 'text-yellow-400'} flex items-center">
                                ${readyIcon}
                                ${isReady ? '요약 준비 완료' : '요약 분석 필요'}
                            </span>
                        </div>
                    </div>
                `;
                newsGrid.appendChild(card);
            });
        };

        async function showDetailPage(item) {
            currentNewsItem = item;
            feedView.classList.add('hidden');
            detailView.classList.remove('hidden');
            
            document.getElementById('news-date-info').textContent = ''; 
            document.getElementById('header-subtitle').textContent = `AI 분석을 통한 ${newsDateText}자 뉴스 상세 요약`;
            
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const detailContainer = document.getElementById('detail-content');
            
            document.getElementById('detail-title').textContent = item.title;
            document.getElementById('detail-region').innerHTML = getRegionTag(item.region);
            document.getElementById('detail-category').className = getCategoryColor(item.category) + ' rounded-lg px-3 py-1 text-sm font-semibold';
            document.getElementById('detail-category').textContent = item.category;
            document.getElementById('detail-source-link').href = item.link && item.link.startsWith('http') ? item.link : '#';
            document.getElementById('detail-source-link').classList.toggle('opacity-50', !item.link || !item.link.startsWith('http'));

            let summaryText = item.detail_summary;
            let sources = item.detail_sources || [];

            if (!summaryText || summaryText.includes('오류가 발생했습니다')) {
                detailContainer.innerHTML = `
                    <div class="text-center py-10">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-indigo-500 border-opacity-50 rounded-full"></div>
                        <p class="text-gray-400 mt-3">Gemini가 Google 검색을 통해 상세 내용을 분석 및 요약 중입니다... (네트워크 요청 발생)</p>
                    </div>`;
                try {
                    const result = await fetchSummaryWithGemini(item.title);
                    summaryText = result.text;
                    sources = result.sources;
                    
                    const index = currentNewsFeed.findIndex(n => n.title === item.title);
                    if (index !== -1) {
                         currentNewsFeed[index].detail_summary = summaryText;
                         currentNewsFeed[index].detail_sources = sources;
                         saveNewsCache(currentNewsFeed);
                    }
                    
                    renderDetailContent(summaryText, sources, detailContainer);
                } catch (error) {
                    detailContainer.innerHTML = `<div class="text-center py-10 text-red-400">요약 정보를 가져오는 데 실패했습니다. (${error.message})</div>`;
                    console.error("Detail Fetch Error:", error);
                }
            } else {
                renderDetailContent(summaryText, sources, detailContainer);
            }
        }
        
        function renderDetailContent(summaryText, sources, containerElement) {
            let summaryHtml = `
                <div class="p-6 md:p-8 bg-gray-900 rounded-xl shadow-inner space-y-4">
                    <h3 class="text-xl md:text-2xl font-bold text-indigo-400 border-b border-gray-700 pb-3 mb-4">뉴스 요약</h3>
                    <div class="text-lg text-gray-200 leading-relaxed whitespace-pre-line">${summaryText}</div>
                </div>`;
            
            if (sources && sources.length > 0) {
                summaryHtml += `
                    <div class="mt-8 pt-4 border-t border-gray-700">
                        <h4 class="text-sm font-bold text-gray-400 mb-2">Gemini 분석에 사용된 정보 출처 (Google Search)</h4>
                        <ul class="space-y-2 text-sm text-gray-500">`;
                sources.slice(0, 3).forEach(src => {
                    summaryHtml += `<li><a href="${src.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-400 truncate block">${src.title || src.uri}</a></li>`;
                });
                summaryHtml += `</ul></div>`;
            }

            containerElement.innerHTML = summaryHtml;
        }

        // -------------------- 이벤트 리스너 설정 --------------------
        
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-700', 'text-gray-300');
                });
                button.classList.add('active', 'bg-indigo-600', 'text-white');
                button.classList.remove('bg-gray-700', 'text-gray-300');

                renderNews(button.dataset.filter);
            });
        });

        // --- 초기화: API 키 상태 확인 후 자동 로드 ---
        document.addEventListener('DOMContentLoaded', async () => {
            const initialButton = document.querySelector('[data-filter="all"]');
            if (initialButton) {
                initialButton.classList.remove('bg-gray-700', 'text-gray-300');
                initialButton.classList.add('bg-indigo-600', 'text-white');
            }

            // API 키 상태 확인
            const hasApiKey = await checkApiKeyStatus();
            
            if (hasApiKey) {
                // API 키가 있으면 자동으로 뉴스 로드
                showFeedPage();
            } else {
                newsGrid.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-400">
                        <p class="text-xl font-bold">서비스 시작</p>
                        <p class="mt-2">Netlify 환경변수에 GEMINI_API_KEY가 설정되면 자동으로 뉴스를 불러와 분석합니다.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
